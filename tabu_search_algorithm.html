<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recherche Tabou - TSP Quest</title>
    <link rel="stylesheet" href="css/main.css">
    <style>
        /* Starfield */
        .starfield { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; overflow: hidden; }
        .star { position: absolute; background: white; border-radius: 50%; animation: twinkle 3s infinite ease-in-out; }
        @keyframes twinkle { 0%,100%{opacity:0.3} 50%{opacity:1} }
        @keyframes moveStars { 0%{transform:translateY(0)} 100%{transform:translateY(-100vh)} }

        /* Nebula */
        .nebula-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: radial-gradient(ellipse at 20% 50%, rgba(255,51,204,0.1) 0%, transparent 50%),
                        radial-gradient(ellipse at 80% 20%, rgba(0,255,204,0.1) 0%, transparent 50%),
                        radial-gradient(ellipse at 40% 80%, rgba(255,204,0,0.1) 0%, transparent 50%);
        }

        /* Jauge Tabou */
        .tabu-gauge { width: 60px; height: 100px; background: #2a2a2a; border: 2px solid #8b00ff; border-radius: 30px; margin: auto; position: relative; overflow: hidden; }
        .tabu-fill { position: absolute; bottom: 0; width: 100%; background: linear-gradient(to top, #8b00ff, #c77dff); border-radius: 28px; transition: height .3s ease; }
        .tabu-label { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 12px; font-weight: bold; text-shadow: 0 0 5px #000; }

        /* Canvas */
        #tsp-canvas { border: 2px solid rgba(255,204,0,0.3); border-radius: 16px; background: rgba(26,26,26,0.3); backdrop-filter: blur(8px); }

        /* Button */
        .btn-pulse { animation: pulse-glow 2s cubic-bezier(0.4,0,0.6,1) infinite; }
        @keyframes pulse-glow { 0%,100% { box-shadow: 0 0 20px rgba(255,204,0,0.3); } 50% { box-shadow: 0 0 40px rgba(255,204,0,0.6); } }
    </style>
</head>
<body class="bg-background text-text-primary overflow-x-hidden">

    <div class="starfield" id="starfield"></div>
    <div class="nebula-bg"></div>

    <!-- Navigation - MÊME LOGO -->
    <nav class="relative z-50 p-6">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center">
                    <span class="text-background font-bold text-lg">T</span>
                </div>
                <span class="text-xl font-bold text-glow">TSP Quest</span>
            </div>
            <div class="hidden md:flex space-x-6">
                <a href="index.html" class="text-text-secondary hover:text-primary">Accueil</a>
                <a href="genetic_rank.html" class="text-text-secondary hover:text-primary">AG - Rang</a>
                <a href="genetic_roulette.html" class="text-text-secondary hover:text-primary">AG - Roulette</a>
                <a href="simulated_annealing.html" class="text-text-secondary hover:text-primary">Recuit Simulé</a>
                <a href="tabu_search_algorithm.html" class="text-primary font-medium">Recherche Tabou</a>
            </div>
            <button class="md:hidden text-primary" id="mobile-menu-btn">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
        </div>
        <div class="md:hidden hidden" id="mobile-menu">
            <div class="glassmorphism mt-4 p-4 rounded-2xl">
                <a href="index.html" class="block py-2 text-text-secondary hover:text-primary">Accueil</a>
                <a href="genetic_rank.html" class="block py-2 text-text-secondary hover:text-primary">AG - Rang</a>
                <a href="genetic_roulette.html" class="block py-2 text-text-secondary hover:text-primary">AG - Roulette</a>
                <a href="simulated_annealing.html" class="block py-2 text-text-secondary hover:text-primary">Recuit Simulé</a>
                <a href="tabu_search_algorithm.html" class="block py-2 text-primary font-medium">Recherche Tabou</a>
            </div>
        </div>
    </nav>

    <!-- Main -->
    <main class="relative z-10 px-6 py-20">
        <div class="max-w-7xl mx-auto">
            <div class="text-center mb-12">
                <h1 class="text-4xl md:text-5xl font-bold mb-4 text-glow">
                    Recherche <span class="text-purple-400">Tabou</span>
                </h1>
                <p class="text-text-secondary text-lg">10 villes – Mémoire active – Résultat en moins de 3s</p>
            </div>

            <div class="grid lg:grid-cols-3 gap-8">
                <!-- Canvas -->
                <div class="lg:col-span-2">
                    <div class="glassmorphism p-6 rounded-2xl">
                        <canvas id="tsp-canvas" width="700" height="550" class="w-full"></canvas>
                        <div class="flex gap-4 mt-6">
                            <button id="start-btn" class="btn-primary btn-pulse px-6 py-3 rounded-xl">Démarrer</button>
                            <button id="reset-btn" class="bg-red-600/20 border border-red-500 text-red-400 px-6 py-3 rounded-xl hover:bg-red-600 hover:text-black transition-all">Réinitialiser</button>
                        </div>
                    </div>
                </div>

                <!-- Panel -->
                <div class="space-y-6">
                    <!-- Jauge Tabou -->
                    <div class="glassmorphism p-6 rounded-2xl text-center">
                        <h3 class="text-lg font-semibold mb-4 text-glow">Mémoire Active</h3>
                        <div class="tabu-gauge">
                            <div class="tabu-fill" id="tabu-fill" style="height:0%"></div>
                            <div class="tabu-label" id="tabu-label">0 / 50</div>
                        </div>
                        <p class="mt-3 text-sm text-text-secondary">Solutions interdites</p>
                    </div>

                    <!-- Paramètres -->
                    <div class="glassmorphism p-6 rounded-2xl">
                        <h3 class="text-lg font-semibold mb-4 text-glow">Paramètres</h3>
                        <div class="space-y-4 text-sm">
                            <div>
                                <label>Itérations</label>
                                <input type="range" id="iterations" min="100" max="2000" value="1000" class="w-full h-2 mt-1">
                                <span id="iterations-val" class="text-primary">1000</span>
                            </div>
                            <div>
                                <label>Taille Tabou</label>
                                <input type="range" id="tabu-size" min="10" max="100" value="50" class="w-full h-2 mt-1">
                                <span id="tabu-size-val" class="text-primary">50</span>
                            </div>
                        </div>
                    </div>

                    <!-- Résultat -->
                    <div class="glassmorphism p-6 rounded-2xl">
                        <h3 class="text-lg font-semibold mb-4 text-glow">Résultat</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>Chemin:</span>
                                <span id="best-path" class="font-mono text-green-400">—</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Distance:</span>
                                <span id="best-distance" class="font-mono text-yellow-400">—</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // === MATRICE DISTANCES ===
        const matrice_distances = [
            [0, 2, 2, 7, 15, 2, 5, 7, 6, 5],
            [2, 0, 10, 4, 7, 3, 7, 15, 8, 2],
            [2, 10, 0, 1, 4, 3, 3, 4, 2, 3],
            [7, 4, 1, 0, 2, 15, 7, 7, 5, 4],
            [7, 10, 4, 2, 0, 7, 3, 2, 2, 7],
            [2, 3, 3, 7, 7, 0, 1, 7, 2, 10],
            [5, 7, 3, 7, 3, 1, 0, 2, 1, 3],
            [7, 7, 4, 7, 2, 7, 2, 0, 1, 10],
            [6, 8, 2, 5, 2, 2, 1, 1, 0, 15],
            [5, 2, 3, 4, 7, 10, 3, 10, 15, 0]
        ];

        // === FONCTIONS CONVERTIES DE TON PYTHON ===
        function calculer_distance_totale(solution) {
            let total = 0;
            for (let i = 0; i < solution.length - 1; i++) {
                total += matrice_distances[solution[i]][solution[i + 1]];
            }
            total += matrice_distances[solution[solution.length - 1]][solution[0]];
            return total;
        }

        function generer_voisins(solution) {
            const voisins = [];
            for (let i = 0; i < solution.length; i++) {
                for (let j = i + 1; j < solution.length; j++) {
                    const voisin = [...solution];
                    [voisin[i], voisin[j]] = [voisin[j], voisin[i]];
                    voisins.push(voisin);
                }
            }
            return voisins;
        }

        function arrayToTuple(arr) {
            return arr.join(',');
        }

        // === ALGORITHME TABOU (avec trace pour animation) ===
        function tabu_search_with_trace(nombre_iterations, taille_tabu) {
            const nombre_villes = matrice_distances.length;
            let solution_actuelle = Array.from({ length: nombre_villes }, (_, i) => i);
            for (let i = solution_actuelle.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [solution_actuelle[i], solution_actuelle[j]] = [solution_actuelle[j], solution_actuelle[i]];
            }

            let meilleur_solution = [...solution_actuelle];
            let meilleur_distance = calculer_distance_totale(solution_actuelle);

            const tabu_list = new Set();
            const trace = [];

            for (let i = 0; i < nombre_iterations; i++) {
                let voisins = generer_voisins(solution_actuelle);
                voisins = voisins.filter(v => !tabu_list.has(arrayToTuple(v)));

                if (voisins.length === 0) break;

                solution_actuelle = voisins.reduce((min, v) => 
                    calculer_distance_totale(v) < calculer_distance_totale(min) ? v : min
                );

                const distance_actuelle = calculer_distance_totale(solution_actuelle);
                const key = arrayToTuple(solution_actuelle);
                tabu_list.add(key);
                if (tabu_list.size > taille_tabu) {
                    const first = tabu_list.keys().next().value;
                    tabu_list.delete(first);
                }

                if (distance_actuelle < meilleur_distance) {
                    meilleur_solution = [...solution_actuelle];
                    meilleur_distance = distance_actuelle;
                }

                trace.push({
                    iteration: i + 1,
                    current: [...solution_actuelle],
                    currentDist: distance_actuelle,
                    best: [...meilleur_solution],
                    bestDist: meilleur_distance,
                    tabuSize: tabu_list.size,
                    tabuMax: taille_tabu
                });
            }

            return trace;
        }

        // === CANVAS ===
        const canvas = document.getElementById('tsp-canvas');
        const ctx = canvas.getContext('2d');
        let cities = [], currentPath = [], bestPath = [], animationId = null;

        function initCities() {
            cities = [];
            const margin = 100, grid = 150;
            for (let i = 0; i < 10; i++) {
                cities.push({ x: margin + (i % 4) * grid, y: margin + Math.floor(i / 4) * grid * 1.5, id: i });
            }
            currentPath = bestPath = Array.from({ length: 10 }, (_, i) => i);
            draw();
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Meilleur chemin
            if (bestPath.length > 1) {
                ctx.strokeStyle = '#00ff88'; ctx.lineWidth = 2; ctx.setLineDash([]);
                ctx.beginPath(); ctx.moveTo(cities[bestPath[0]].x, cities[bestPath[0]].y);
                bestPath.forEach((id, i) => { if (i > 0) ctx.lineTo(cities[id].x, cities[id].y); });
                ctx.closePath(); ctx.stroke();
            }

            // Chemin actuel
            if (currentPath.length > 1) {
                ctx.strokeStyle = '#c77dff'; ctx.lineWidth = 3; ctx.setLineDash([8, 8]);
                ctx.beginPath(); ctx.moveTo(cities[currentPath[0]].x, cities[currentPath[0]].y);
                currentPath.forEach((id, i) => { if (i > 0) ctx.lineTo(cities[id].x, cities[id].y); });
                ctx.closePath(); ctx.stroke(); ctx.setLineDash([]);
            }

            // Villes
            cities.forEach(c => {
                ctx.fillStyle = '#c77dff'; ctx.beginPath(); ctx.arc(c.x, c.y, 14, 0, Math.PI * 2); ctx.fill();
                ctx.fillStyle = 'white'; ctx.font = 'bold 16px Inter'; ctx.textAlign = 'center';
                ctx.fillText(c.id, c.x, c.y + 6);
            });
        }

        // === JAUGE ===
        function updateGauge(cur, max) {
            const fill = document.getElementById('tabu-fill');
            const label = document.getElementById('tabu-label');
            const pct = (cur / max) * 100;
            fill.style.height = pct + '%';
            label.textContent = cur + ' / ' + max;
        }

        // === LANCEMENT ALGO ===
        let isRunning = false;
        function startTabu() {
            if (isRunning) return;
            isRunning = true;
            document.getElementById('start-btn').disabled = true;

            const iterations = +document.getElementById('iterations').value;
            const tabuSize = +document.getElementById('tabu-size').value;

            const trace = tabu_search_with_trace(iterations, tabuSize);

            let idx = 0;
            function step() {
                if (idx >= trace.length) {
                    const final = trace[trace.length - 1];
                    bestPath = final.best;
                    document.getElementById('best-path').textContent = final.best.join(' to ');
                    document.getElementById('best-distance').textContent = final.bestDist;
                    draw();
                    isRunning = false;
                    document.getElementById('start-btn').disabled = false;
                    return;
                }
                const s = trace[idx++];
                currentPath = s.current;
                bestPath = s.best;
                updateGauge(s.tabuSize, s.tabuMax);
                draw();
                animationId = requestAnimationFrame(step);
            }
            step();
        }

        function reset() {
            if (animationId) cancelAnimationFrame(animationId);
            isRunning = false;
            document.getElementById('start-btn').disabled = false;
            initCities();
            document.getElementById('best-path').textContent = '—';
            document.getElementById('best-distance').textContent = '—';
            updateGauge(0, +document.getElementById('tabu-size').value);
        }

        // === ÉVÉNEMENTS ===
        document.getElementById('start-btn').addEventListener('click', startTabu);
        document.getElementById('reset-btn').addEventListener('click', reset);
        ['iterations', 'tabu-size'].forEach(id => {
            const input = document.getElementById(id);
            const span = document.getElementById(id + '-val');
            input.addEventListener('input', () => {
                span.textContent = input.value;
                if (id === 'tabu-size') updateGauge(0, input.value);
            });
        });
        document.getElementById('mobile-menu-btn').addEventListener('click', () => {
            document.getElementById('mobile-menu').classList.toggle('hidden');
        });

        // === INIT + STARFIELD ===
        initCities();
        updateGauge(0, 50);
        createStarfield();

        function createStarfield() {
            const sf = document.getElementById('starfield');
            for (let i = 0; i < 200; i++) {
                const s = document.createElement('div'); s.className = 'star';
                s.style.left = Math.random() * 100 + '%';
                s.style.top = Math.random() * 100 + '%';
                const sz = Math.random() * 3 + 1;
                s.style.width = s.style.height = sz + 'px';
                s.style.animationDelay = Math.random() * 3 + 's';
                s.style.animation += `, moveStars ${Math.random() * 20 + 10}s linear infinite`;
                sf.appendChild(s);
            }
        }
    </script>
    <script id="dhws-dataInjector" src="../public/dhws-data-injector.js"></script>
</body>
</html>